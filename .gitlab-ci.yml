stages:
  - lint
  - test
  - quality

before_script:
  - python --version
  - pip install --upgrade pip

lint:flake8:
  stage: lint
  image: python:3.13
  script:
    - pip install flake8
    - flake8 app.py --max-line-length=120
  allow_failure: false

lint:pylint:
  stage: lint
  image: python:3.13
  script:
    - pip install pylint
    - pylint app.py --fail-under=7.0
  allow_failure: false

test:unit:
  stage: test
  image: python:3.13
  script:
    - pip install -r requirements.txt
    - pip install pytest pytest-cov
    - pytest test_app.py -v --cov=app --cov-report=term --cov-report=html
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 1 week

quality:coverage:
  stage: quality
  image: python:3.13
  script:
    - pip install -r requirements.txt
    - pip install pytest pytest-cov
    - pytest test_app.py --cov=app --cov-report=term --cov-report=xml --cov-fail-under=80
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

quality:security:
  stage: quality
  image: python:3.13
  script:
    - pip install bandit
    - bandit -r app.py -f json -o bandit-report.json || true
    - bandit -r app.py
  allow_failure: true
  artifacts:
    paths:
      - bandit-report.json
    expire_in: 1 week
